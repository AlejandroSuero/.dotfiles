---
- name: Neovim | Dependencies | {{ ansible_distribution }}
  block:
    - name: Neovim | Detecting Installed cmake
      ansible.builtin.command:
        cmd: which cmake
      changed_when: false
      register: cmake_cmd
      failed_when: false

    - name: Neovim | Register cmake status installed
      ansible.builtin.set_fact:
        cmake_is_installed: true
      when: cmake_cmd.stdout|length > 0

    - name: Neovim | Register cmake status not installed
      ansible.builtin.set_fact:
        cmake_is_installed: false
      when: cmake_cmd.stdout|length == 0

    - name: Neovim | Install cmake
      ansible.builtin.package:
        name:
          - cmake
        state: present
      when: not cmake_is_installed

    - name: Neovim | Dependencies | Install
      ansible.builtin.package:
        name:
          - curl
          - ansible-lint
          - ripgrep
          - fd
          - ninja
          - gettext
        state: present

- name: Neovim | Installation | {{ ansible_distribution }}
  block:
    - name: Neovim | Clone repo
      ansible.builtin.git:
        clone: true
        depth: 1
        repo: https://github.com/neovim/neovim.git
        force: true
        update: true
        dest: "{{ ansible_user_dir }}/neovim"
        version: stable
      register: clone

    - name: Neovim | Build
      community.general.make:
        chdir: "{{ ansible_user_dir }}/neovim"
        params:
          CMAKE_BUILD_TYPE: RelWithDebInfo

    - name: Neovim | Install
      community.general.make:
        chdir: "{{ ansible_user_dir }}/neovim"
        target: install
      become: true

    - name: Remove build folder
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/neovim"
        state: absent
      become: true
